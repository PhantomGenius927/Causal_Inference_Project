---
title: "Final Project"
author: "Edison Hu"
format: pdf
editor: visual
date: (\today)
execute: 
  warning: false
  message: false
---

```{r, echo=FALSE}
library(fixest)
library(peacesciencer)
library(ggplot2)
library(tidyverse)
```
##Data Wrangling
```{r Data Wrangling}
ids <- c("ccode1", "ccode2", "country1", "country2", "year")

# Outcome Variable
## MID onsets
dyadyrs <- create_dyadyears(directed = FALSE, subset_years = c(1816:2014)) %>%
  add_cow_mids() %>%
  mutate(
    country1 = countrycode::countrycode(ccode1, 
                                        origin = "cown", destination = "iso3c"),
    country2 = countrycode::countrycode(ccode2, 
                                        origin = "cown", destination = "iso3c")  
    ) %>%
  select(all_of(ids), cowmidonset)

# Explanatory Variable
## regime change
polityIV <- readxl::read_xls(here::here("raw data/p4v2018.xls"))
polityIV <- polityIV %>%
  select(ccode, year, durable) %>%
  mutate(ccode2 = ccode) %>%
  rename(ccode1 = ccode)

dyadyrs <- left_join(dyadyrs, polityIV, by = c("ccode1", "year"))
dyadyrs <- dyadyrs %>%
  select(-ccode2.y) %>%
  rename(durable1 = durable,
         ccode2 = ccode2.x)
dyadyrs <- left_join(dyadyrs, polityIV, by = c("ccode2", "year"))
dyadyrs <- dyadyrs %>%
  select(-ccode1.y) %>%
  rename(durable2 = durable,
         ccode1 = ccode1.x)

dyadyrs <- dyadyrs %>%
  mutate(
    regcha1 = ifelse(durable1 == 0, 1, 0),
    regcha2 = ifelse(durable2 == 0, 1, 0),
    regcha_uni = ifelse(regcha1 == 1 | regcha2 == 1, 1, 0)
    #regcha_bi = ifelse(regcha1 == 1 & regcha2 == 1, 1, 0)
    ) %>%
  select(all_of(ids), cowmidonset, regcha_uni)

## foreign policy similarity
dyadyrs <- dyadyrs %>%
  add_fpsim() %>%
  select(all_of(ids), cowmidonset, regcha_uni, piva, kappava)

# Covariates
## alliance
dyadyrs <- dyadyrs %>%
  add_cow_alliance()

## major power
dyadyrs <- dyadyrs %>%
  add_cow_majors() %>%
  mutate(major = ifelse(cowmaj1 == 1 | cowmaj2 == 1, 1, 0)) %>%
  select(-c(cowmaj1, cowmaj2))

## strategic rivalry
v_ids <- names(dyadyrs)
dyadyrs <- dyadyrs %>%
  add_strategic_rivalries() %>%
  select(all_of(v_ids), ongoingrivalry)

## distance
dyadyrs <- dyadyrs %>%
  add_minimum_distance()

## GDP per capita & Trade
v_ids <- names(dyadyrs)
dyadyrs <- dyadyrs %>%
  add_sdp_gdp() %>%
  add_cow_trade() %>%
  mutate(
    gdppc = abs(wbgdppc2011est1 - wbgdppc2011est2),
    trade = abs(flow1 - flow2)
  ) %>%
  group_by(year) %>%
  mutate(
    gdppc_dyd = (gdppc - mean(gdppc, na.rm = TRUE)) / sd(gdppc, na.rm = TRUE),
    trade_dyd = (trade - mean(trade, na.rm = TRUE)) / sd(trade, na.rm = TRUE)
  ) %>%
  ungroup() 
dyadyrs <- dyadyrs %>%
  select(all_of(v_ids), gdppc_dyd, trade_dyd)
  
## NMC ratio
v_ids <- names(dyadyrs)
nmc_sy <- cow_nmc %>%
  group_by(year) %>%
  mutate(
    nc = cinc / sum(cinc)
    ) %>%
  ungroup() %>%
  rename(ccode1 = ccode,
         nc1 = nc) %>%
  select(ccode1, year, nc1)
dyadyrs <- left_join(dyadyrs, nmc_sy, by = c("ccode1", "year"))

nmc_sy <- nmc_sy %>%
  rename(ccode2 = ccode1,
         nc2 = nc1)
dyadyrs <- left_join(dyadyrs, nmc_sy, by = c("ccode2", "year"))
dyadyrs <- dyadyrs %>%
  mutate(
    nc = abs(nc1 - nc2)
    ) %>%
  group_by(year) %>%
  mutate(
    nmc_dyd = (nc - mean(nc, na.rm = TRUE)) / sd(nc, na.rm = TRUE)
    ) %>%
  ungroup() %>%
  select(all_of(v_ids), nmc_dyd)

## create unique id
dyadyrs <- dyadyrs %>%
  mutate(
    id = paste(ccode1, ccode2, sep = "0")
  )
```

# Treatment Year
```{r Treatment Year}
## min treated year
dyadyrs <- dyadyrs %>%
  group_by(id) %>%
  mutate(
    regchayr = ifelse(regcha_uni == 1, year, NA),
    treatyr_sing = min(regchayr, na.rm = TRUE),
    treatyr_multi = regchayr
  ) %>%
  fill(treatyr_multi, .direction = "down") %>%
  ungroup() %>%
  select(-regchayr)

```
## Effect Size
```{r Effect Size}
ees <- feols(cowmidonset ~ regcha_uni | year + ccode1 + ccode2, data = dyadyrs)
etable(ees, file = here::here("ees.tex"))

mde <- pwr::pwr.t.test(n = n_distinct(dyadyrs)/2, d = NULL, 
                       sig.level = 0.05, power = 0.8, 
                       type="two.sample", alternative="two.sided")
plot(mde)
```
## Parallel Trend Analysis
```{r Parallel Trend Analysis}
trend_dyadyrs <- dyadyrs %>%
  group_by(year, id)
```

## Statistical Analysis
```{r Statistical Analysis}

covariates <- c("cow_defense", "cow_neutral", "cow_nonagg", "cow_entente", 
                "major", "ongoingrivalry", 
                "mindist",
                "gdppc_dyd", "trade_dyd", "nmc_dyd")

media_test <- feols(c(cow_defense, cow_neutral, cow_nonagg, cow_entente, 
                      major, ongoingrivalry, 
                      mindist, I(mindist^2),
                      gdppc_dyd, trade_dyd, nmc_dyd) ~ regcha_uni | 
                      year + ccode1 + ccode2, data = dyadyrs)
etable(media_test)

# OLS
m <- feols(cowmidonset ~ regcha_uni + 
             piva + regcha_uni:piva + 
             ongoingrivalry + regcha_uni:ongoingrivalry +
             cow_defense + cow_neutral + cow_nonagg + cow_entente +
             major + regcha_uni:major + 
             mindist + regcha_uni:mindist + 
             I(mindist^2) + regcha_uni:I(mindist^2) +
             trade_dyd + gdppc_dyd + nmc_dyd, 
           data = dyadyrs)
etable(m)

# Key Explanatory Variable 1 Without Covariates
m1.1 <- feols(cowmidonset ~ regcha_uni + 
                piva + regcha_uni:piva | 
                id + year, 
              data = dyadyrs)
m1.2 <- feols(cowmidonset ~ regcha_uni + 
                piva + regcha_uni:piva | 
                id + year, 
              cluster = c("year", "id"), data = dyadyrs)
m1.3 <- feols(cowmidonset ~ regcha_uni + 
                piva + regcha_uni:piva | 
              ccode1 + ccode2 + year, data = dyadyrs)
m1.4 <- feols(cowmidonset ~ regcha_uni  + 
                piva + regcha_uni:piva | 
              ccode1 + ccode2 + year, 
              cluster = c("year", "ccode1", "ccode2"), data = dyadyrs)
etable(m1.1, m1.2, m1.3, m1.4)

m1.1.2 <- feols(cowmidonset ~ regcha_uni + 
                  kappava + regcha_uni:kappava | 
                  id + year, 
                data = dyadyrs)
m1.2.2  <- feols(cowmidonset ~ regcha_uni + 
                   kappava + regcha_uni:kappava | 
                   id + year, 
                 cluster = c("year", "id"), data = dyadyrs)
m1.3.2  <- feols(cowmidonset ~ regcha_uni + 
                   kappava + regcha_uni:kappava | 
                   ccode1 + ccode2 + year, data = dyadyrs)
m1.4.2  <- feols(cowmidonset ~ regcha_uni  + 
                   kappava + regcha_uni:kappava | 
                   ccode1 + ccode2 + year, 
                 cluster = c("year", "ccode1", "ccode2"), data = dyadyrs)
etable(m1.1.2, m1.2.2, m1.3.2, m1.4.2)

# TWFE with Key Explanatory Variables With Covariates
m2.1 <- feols(cowmidonset ~ regcha_uni + 
                ongoingrivalry + regcha_uni:ongoingrivalry +
                cow_defense + cow_neutral + cow_nonagg + cow_entente +
                major + regcha_uni:major + 
                mindist + regcha_uni:mindist + 
                I(mindist^2) + regcha_uni:I(mindist^2) +
                trade_dyd + gdppc_dyd + nmc_dyd | 
                id + year, 
              cluster = c("year", "id"), data = dyadyrs)
m2.2 <- feols(cowmidonset ~ regcha_uni + 
                ongoingrivalry + regcha_uni:ongoingrivalry +
                cow_defense + cow_neutral + cow_nonagg + cow_entente +
                major + regcha_uni:major + 
                mindist + regcha_uni:mindist + 
                I(mindist^2) + regcha_uni:I(mindist^2) +
                trade_dyd + gdppc_dyd + nmc_dyd | 
                ccode1 + ccode2 + year, 
              cluster = c("year", "ccode1", "ccode2"), data = dyadyrs)
etable(m2.1, m2.2)

# Key Explanatory Variable 2 Without Covariates
m3.1 <- feols(cowmidonset ~ regcha_uni + 
                ongoingrivalry + regcha_uni:ongoingrivalry | 
                id + year, 
              data = dyadyrs)
m3.2 <- feols(cowmidonset ~ regcha_uni + 
                ongoingrivalry + regcha_uni:ongoingrivalry | 
                id + year, 
              cluster = c("year", "id"), data = dyadyrs)
m3.3 <- feols(cowmidonset ~ regcha_uni + 
                ongoingrivalry + regcha_uni:ongoingrivalry | 
                ccode1 + ccode2 + year, 
              data = dyadyrs)
m3.4 <- feols(cowmidonset ~ regcha_uni  + 
                ongoingrivalry + regcha_uni:ongoingrivalry | 
                ccode1 + ccode2 + year, 
              cluster = c("year", "ccode1", "ccode2"), data = dyadyrs)
etable(m3.1, m3.2, m3.3, m3.4)

# TWFE With Two Key Explanatory Variables With Covariates
m4 <- feols(cowmidonset ~ regcha_uni + 
              piva + regcha_uni:piva + 
              I(piva^2) + regcha_uni:I(piva^2) + 
              ongoingrivalry + regcha_uni:ongoingrivalry +
              cow_defense + cow_neutral + cow_nonagg + cow_entente +
              major + regcha_uni:major + 
              mindist + regcha_uni:mindist + 
              I(mindist^2) + regcha_uni:I(mindist^2) +
              trade_dyd + gdppc_dyd + nmc_dyd | 
              ccode1 + ccode2 + year, 
            cluster = c("year", "ccode1", "ccode2"), data = dyadyrs)
etable(m4)
```
