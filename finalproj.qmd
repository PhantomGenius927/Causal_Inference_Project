---
title: "Final Project"
author: "Edison Hu"
format: pdf
editor: visual
date: (\today)
execute: 
  warning: false
  message: false
---

```{r, echo=FALSE}
library(fixest)
library(peacesciencer)
library(ggplot2)
library(tidyverse)
library(did)
#library(MatchIt)
library(HonestDiD)
```
```{r For Honest DiD}
#' @title honest_did
#'
#' @description a function to compute a sensitivity analysis
#'  using the approach of Rambachan and Roth (2021)
honest_did <- function(...) UseMethod("honest_did")

#' @title honest_did.AGGTEobj
#'
#' @description a function to compute a sensitivity analysis
#'  using the approach of Rambachan and Roth (2021) when
#'  the event study is estimating using the `did` package
#'
#' @param e event time to compute the sensitivity analysis for.
#'  The default value is `e=0` corresponding to the "on impact"
#'  effect of participating in the treatment.
#' @param type Options are "smoothness" (which conducts a
#'  sensitivity analysis allowing for violations of linear trends
#'  in pre-treatment periods) or "relative_magnitude" (which
#'  conducts a sensitivity analysis based on the relative magnitudes
#'  of deviations from parallel trends in pre-treatment periods).
#' @inheritParams HonestDiD::createSensitivityResults
#' @inheritParams HonestDid::createSensitivityResults_relativeMagnitudes
honest_did.AGGTEobj <- function(es,
                                e          = 0,
                                type       = c("smoothness", "relative_magnitude"),
                                gridPoints = 100,
                                ...) {

  type <- match.arg(type)

  # Make sure that user is passing in an event study
  if (es$type != "dynamic") {
    stop("need to pass in an event study")
  }

  # Check if used universal base period and warn otherwise
  if (es$DIDparams$base_period != "universal") {
    stop("Use a universal base period for honest_did")
  }

  # Recover influence function for event study estimates
  es_inf_func <- es$inf.function$dynamic.inf.func.e

  # Recover variance-covariance matrix
  n <- nrow(es_inf_func)
  V <- t(es_inf_func) %*% es_inf_func / n / n

  # Check time vector is consecutive with referencePeriod = -1
  referencePeriod <- -1
  consecutivePre  <- !all(diff(es$egt[es$egt <= referencePeriod]) == 1)
  consecutivePost <- !all(diff(es$egt[es$egt >= referencePeriod]) == 1)
  if ( consecutivePre | consecutivePost ) {
    msg <- "honest_did expects a time vector with consecutive time periods;"
    msg <- paste(msg, "please re-code your event study and interpret the results accordingly.", sep="\n")
    stop(msg)
  }

  # Remove the coefficient normalized to zero
  hasReference <- any(es$egt == referencePeriod)
  if ( hasReference ) {
    referencePeriodIndex <- which(es$egt == referencePeriod)
    V    <- V[-referencePeriodIndex,-referencePeriodIndex]
    beta <- es$att.egt[-referencePeriodIndex]
  } else {
    beta <- es$att.egt
  }

  nperiods <- nrow(V)
  npre     <- sum(1*(es$egt < referencePeriod))
  npost    <- nperiods - npre
  if ( !hasReference & (min(c(npost, npre)) <= 0) ) {
    if ( npost <= 0 ) {
      msg <- "not enough post-periods"
    } else {
      msg <- "not enough pre-periods"
    }
    msg <- paste0(msg, " (check your time vector; note honest_did takes -1 as the reference period)")
    stop(msg)
  }

  baseVec1 <- basisVector(index=(e+1),size=npost)
  orig_ci  <- constructOriginalCS(betahat        = beta,
                                  sigma          = V,
                                  numPrePeriods  = npre,
                                  numPostPeriods = npost,
                                  l_vec          = baseVec1)

  if (type=="relative_magnitude") {
    robust_ci <- createSensitivityResults_relativeMagnitudes(betahat        = beta,
                                                             sigma          = V,
                                                             numPrePeriods  = npre,
                                                             numPostPeriods = npost,
                                                             l_vec          = baseVec1,
                                                             gridPoints     = gridPoints,
                                                             ...)

  } else if (type == "smoothness") {
    robust_ci <- createSensitivityResults(betahat        = beta,
                                          sigma          = V,
                                          numPrePeriods  = npre,
                                          numPostPeriods = npost,
                                          l_vec          = baseVec1,
                                          ...)
  }

  return(list(robust_ci=robust_ci, orig_ci=orig_ci, type=type))
}
```

##Data Wrangling

```{r Data Wrangling}
ids <- c("ccode1", "ccode2", "country1", "country2", "year")

# Outcome Variable
## MID onsets
dyadyrs <- create_dyadyears(directed = FALSE, subset_years = c(1945:2010)) %>%
  add_cow_mids() %>%
  mutate(
    country1 = countrycode::countrycode(ccode1, 
                                        origin = "cown", destination = "iso3c"),
    country2 = countrycode::countrycode(ccode2, 
                                        origin = "cown", destination = "iso3c")  
    ) %>%
  select(all_of(ids), cowmidonset)

# Explanatory Variable
## regime change
polityIV <- readxl::read_xls(here::here("raw data/p4v2018.xls"))
polityIV <- polityIV %>%
  select(ccode, year, durable) %>%
  mutate(ccode2 = ccode) %>%
  rename(ccode1 = ccode)

dyadyrs <- left_join(dyadyrs, polityIV, by = c("ccode1", "year"))
dyadyrs <- dyadyrs %>%
  select(-ccode2.y) %>%
  rename(durable1 = durable,
         ccode2 = ccode2.x)
dyadyrs <- left_join(dyadyrs, polityIV, by = c("ccode2", "year"))
dyadyrs <- dyadyrs %>%
  select(-ccode1.y) %>%
  rename(durable2 = durable,
         ccode1 = ccode1.x)

dyadyrs <- dyadyrs %>%
  mutate(
    regcha1 = ifelse(durable1 == 0, 1, 0),
    regcha2 = ifelse(durable2 == 0, 1, 0),
    regcha_uni = ifelse(regcha1 == 1 | regcha2 == 1, 1, 0)
    #regcha_bi = ifelse(regcha1 == 1 & regcha2 == 1, 1, 0)
    ) %>%
  select(all_of(ids), cowmidonset, regcha_uni)

## foreign policy similarity
dyadyrs <- dyadyrs %>%
  add_fpsim() %>%
  select(all_of(ids), cowmidonset, regcha_uni, piva, kappava)

# Covariates
## alliance
dyadyrs <- dyadyrs %>%
  add_cow_alliance() %>%
  mutate(
    alliance = ifelse(cow_defense == 1 | cow_neutral== 1 | cow_nonagg == 1 | cow_entente == 1, 1, 0)
  ) %>%
  select(-c(cow_defense, cow_neutral, cow_nonagg, cow_entente))

## major power
dyadyrs <- dyadyrs %>%
  add_cow_majors() %>%
  mutate(major = ifelse(cowmaj1 == 1 | cowmaj2 == 1, 1, 0)) %>%
  select(-c(cowmaj1, cowmaj2))

## strategic rivalry
v_ids <- names(dyadyrs)
dyadyrs <- dyadyrs %>%
  add_strategic_rivalries() %>%
  select(all_of(v_ids), ongoingrivalry)

## distance
dyadyrs <- dyadyrs %>%
  add_minimum_distance()

## GDP per capita & Trade
v_ids <- names(dyadyrs)
dyadyrs <- dyadyrs %>%
  add_sdp_gdp() %>%
  add_cow_trade() %>%
  mutate(
    gdppc = wbgdppc2011est1 + wbgdppc2011est2,
    trade = flow1 + flow2
  ) %>%
  group_by(year) %>%
  mutate(
    gdppc_dyd = (gdppc - mean(gdppc, na.rm = TRUE)) / sd(gdppc, na.rm = TRUE),
    trade_dyd = (trade - mean(trade, na.rm = TRUE)) / sd(trade, na.rm = TRUE)
  ) %>%
  ungroup() 
dyadyrs <- dyadyrs %>%
  select(all_of(v_ids), gdppc, gdppc_dyd, trade, trade_dyd)
  
## Capability ratio
v_ids <- names(dyadyrs)
nmc_sy <- cow_nmc %>%
  rename(ccode1 = ccode,
         nc1 = cinc) %>%
  select(ccode1, year, nc1)
dyadyrs <- left_join(dyadyrs, nmc_sy, by = c("ccode1", "year"))

nmc_sy <- nmc_sy %>%
  rename(ccode2 = ccode1,
         nc2 = nc1)
dyadyrs <- left_join(dyadyrs, nmc_sy, by = c("ccode2", "year"))
dyadyrs <- dyadyrs %>%
  mutate(
    nc = abs(nc1 - nc2)
    ) %>%
  group_by(year) %>%
  mutate(
    nmc_dyd = (nc - mean(nc, na.rm = TRUE)) / sd(nc, na.rm = TRUE)
    ) %>%
  ungroup() %>%
  select(all_of(v_ids), nc, nmc_dyd)

## create unique id
dyadyrs <- dyadyrs %>%
  mutate(
    id = paste(ccode1, ccode2, sep = "0")
  )
```

# Treatment Year

```{r Treatment Year}
## treated year with single and multi-entry year
dyadyrs <- dyadyrs %>%
  group_by(id) %>%
  mutate(
    regchayr = ifelse(regcha_uni == 1, year, NA),
    treatyr_sing = min(regchayr, na.rm = TRUE)
    ) %>%
  ungroup() %>%
  select(-regchayr)
#dyadyrs$treatyr_sing[dyadyrs$treatyr_sing == Inf] <- NA
#dyadyrs <- dyadyrs %>%
#  group_by(id) %>%
#  mutate(
#    regchayr = ifelse(regcha_uni == 1, year, NA),
#    treatyr_sing = min(regchayr, na.rm = TRUE),
#    treatyr_multi = regchayr
#  ) %>%
#  fill(treatyr_multi, .direction = "down") %>%
#  ungroup() %>%
#  select(-regchayr)

## unique cases id for multi-entry year dyads
#dyadyrs <- dyadyrs %>%
#  mutate(
#    case_id = row_number()
#  ) %>%
#  group_by(id, treatyr_multi) %>%
#  mutate(
#    case_id = min(case_id, na.rm = TRUE)
# ) %>%
#  ungroup()
```

## Descriptive Analysis

```{r}
da <- dyadyrs %>%
  group_by(year) %>%
  summarise(
    onset = sum(cowmidonset, na.rm = TRUE),
    regime = sum(regcha_uni, na.rm = TRUE),
    avg_kappava = mean(kappava, na.rm = TRUE),
    sd_kappava = sd(kappava, na.rm = TRUE),
    alliance = sum(alliance, na.rm = TRUE),
    major = sum(major, na.rm = TRUE),
    rivalry = sum(ongoingrivalry, na.rm = TRUE),
    avg_gdppc = mean(gdppc, na.rm = TRUE),
    sd_gdppc = sd(gdppc, na.rm = TRUE),
    avg_trade = mean(trade, na.rm = TRUE),
    sd_trade = sd(trade, na.rm = TRUE),
    avg_nmc = mean(nc, na.rm = TRUE),
    sd_nmc = sd(nc, na.rm = TRUE)
  )

ggplot(data = da) +
  geom_line(aes(x = year, y = onset), color = "darkred", linewidth = 0.7) + 
  labs(
    x = "Year",
    y = "Numbers of Onsets",
    caption = "Source: Correlates of War (CoW) Militarized Interstate Dispute (MID) project. (V5.0)"
  ) + 
  ggthemes::theme_clean(base_size = 11) + 
  theme(text = element_text(family = "Crimson Text"))
ggsave(filename = here::here("plots/onset.png"), device = "png", 
        width = 5, height = 3, units = "in", dpi = 300, limitsize = FALSE)

ggplot(data = da) +
  geom_line(aes(x = year, y = regime), color = "darkgoldenrod1", linewidth = 0.7) + 
  labs(
    x = "Year",
    y = "Numbers of Dyads with Regime Change",
    caption = "Source: Polity IV Project (2018)"
  ) + ggthemes::theme_clean(base_size = 11) + 
  theme(text = element_text(family = "Crimson Text"))
ggsave(filename = here::here("plots/regime1945.png"), device = "png", 
        width = 5, height = 3, units = "in", dpi = 300, limitsize = FALSE)

#ggplot(data = da) +
#  geom_line(aes(x = year, y = regime), color = "darkgoldenrod1", linewidth = 0.7) + 
#  labs(
#    x = "Year",
#    y = "Numbers of Dyads with Regime Change",
#   caption = "Source: Polity IV Project (2018)"
#  ) + ggthemes::theme_clean(base_size = 11) + 
#  geom_vline(xintercept = 1945, color = "black") +
#  theme(text = element_text(family = "Crimson Text"))
#ggsave(filename = here::here("plots/regime1816.png"), device = "png", 
#       width = 5, height = 3, units = "in", dpi = 300, limitsize = FALSE)
```

## Effect Size

```{r Effect Size}
ees <- feols(cowmidonset ~ regcha_uni | year + ccode1 + ccode2, data = dyadyrs)
etable(ees, file = here::here("tables/ees.tex"), view = TRUE)

mde <- pwr::pwr.t.test(n = n_distinct(dyadyrs)/2, d = NULL, 
                       sig.level = 0.05, power = 0.8, 
                       type="two.sample", alternative="two.sided")

font <- "Crimson Text" # Change to your desired font
png(file.path("plots", "mde.png"), res = 300, width = 5, height = 3, units = "in")
par(family = font)
plot(mde)
dev.off()
```

## Parallel Trend Analysis

```{r Parallel Trend Analysis}
# single entry
pta <- dyadyrs %>%
  group_by(id) %>%
  mutate(
    mid = cowmidonset - lag(cowmidonset)
  ) %>%
  summarise(
    avg_mid = mean(mid, na.rm = TRUE),
    treatyr = unique(treatyr_sing)
  )

pta_model <- feols(treatyr ~ avg_mid, data = pta)
etable(pta_model, file = here::here("tables/pta.tex"), view = TRUE)

ggplot(pta, aes(x = treatyr, y = avg_mid)) +
  geom_smooth(method = "lm", se = TRUE) + 
  ggthemes::theme_clean(base_size = 11) +
  theme(text = element_text(family = "Crimson Text")) + 
  labs(
    x = "Year of Regime Change",
    y = "Average Change of Militarized Interstate Dispute's Possibility",
    caption = "Source: COW MIDs Dataset"
  )
ggsave(filename = here::here("plots/paratrend.png"), device = "png", limitsize = FALSE, dpi = 300)


fractions = dyadyrs %>% 
  group_by(year) %>% 
  summarize(
    dyads = n_distinct(id),
    indyads = sum(regcha_uni, na.rm=TRUE),
    fracmid = mean(cowmidonset, na.rm=TRUE))

ggplot(data=fractions,aes(x=year)) + 
  ggthemes::theme_clean(base_size=11) + 
  xlab("Year") +
  #geom_line(aes(y=fracmid), col="darkred") +
  geom_line(aes(y=indyads*0.01), col="blue") +
  scale_y_continuous(
    name="Fraction Default")
    #sec.axis = sec_axis(~./0.01,name="Number in Bureau"))

# multi-entry 
#demo <- dyadyrs %>%
#  group_by(case_id) %>%
#  mutate(
#    mid = cowmidonset - lag(cowmidonset) # try n = 5
#  ) %>%
#  summarise(
#    avg_mid = mean(mid, na.rm = TRUE),
#    treatyr_multi = unique(treatyr_multi)
#  )

#idk <- feols(treatyr_multi ~ avg_mid, data = demo)
#etable(idk)

#ggplot(demo, aes(x = treatyr_multi)) +
#  geom_smooth(aes(y = avg_mid), se = TRUE)

```

## Cross-sectional Endogeneity Test

```{r}
cset <- dyadyrs %>%
  group_by(id)  %>%
  summarise(
    treatyr = unique(treatyr_sing),
    avg_kappava = mean(kappava, na.rm = TRUE),
    alliance = mean(alliance, na.rm = TRUE),
    major = mean(major, na.rm = TRUE),
    rivalry = mean(ongoingrivalry, na.rm = TRUE),
    avg_gdppc = mean(gdppc, na.rm = TRUE),
    avg_trade = mean(trade, na.rm = TRUE),
    avg_nmc = mean(nc, na.rm = TRUE),
  )

m <- feols(treatyr ~ avg_gdppc, data = cset)
a <- feols(treatyr ~ avg_trade, data = cset)
y <- feols(treatyr ~ avg_nmc, data = cset)
d <- feols(treatyr ~ major, data = cset)
r <- feols(treatyr ~ alliance, data = cset)
t <- feols(treatyr ~ rivalry, data = cset)


etable(m, a, y, d, r, t, view = TRUE, file = here::here("tables/cset.tex"))
# Display tables
stargazer(m,a,y,, type = "text", )

```


## TWFE

```{r Matching}
#mdyadyrs <- dyadyrs %>%
#  drop_na(regcha_uni, ongoingrivalry, alliance, major,
#          mindist, trade_dyd, gdppc_dyd, nmc_dyd)
#m.out <- matchit(regcha_uni ~ ongoingrivalry +
#             alliance +
#             major +
#             mindist + I(mindist^2) +
#             trade_dyd + gdppc_dyd + nmc_dyd,
#             distance = "mahalanobis", data = mdyadyrs)

# Checking balance prior to matching
#summary(m.out, un = FALSE)


#ps_model <- glm(regcha_uni ~ ongoingrivalry +
#               factor(year) + factor(id), data = mdyadyrs, family = binomial)
```

```{r TWFE}
# OLS
m <- feols(cowmidonset ~ regcha_uni + 
             kappava + regcha_uni:kappava + 
             ongoingrivalry + regcha_uni:ongoingrivalry +
             alliance +
             major + regcha_uni:major + 
             mindist + regcha_uni:mindist + 
             I(mindist^2) + regcha_uni:I(mindist^2) +
             trade_dyd + gdppc_dyd + nmc_dyd, 
           data = dyadyrs)
etable(m)

# Key Explanatory Variable 1 Without Covariates
m1.1 <- feols(cowmidonset ~ regcha_uni + 
                kappava + regcha_uni:kappava | 
                id + year, 
              data = dyadyrs)
m1.2 <- feols(cowmidonset ~ regcha_uni + 
                kappava + regcha_uni:kappava | 
                id + year, 
              cluster = c("year", "id"), data = dyadyrs)
m1.3 <- feols(cowmidonset ~ regcha_uni + 
                kappava + regcha_uni:kappava | 
              ccode1 + ccode2 + year, data = dyadyrs)
m1.4 <- feols(cowmidonset ~ regcha_uni  + 
                kappava + regcha_uni:kappava | 
              ccode1 + ccode2 + year, 
              cluster = c("year", "ccode1", "ccode2"), data = dyadyrs)
etable(m1.1, m1.2, m1.3, m1.4)

# TWFE with Key Explanatory Variables With Covariates
m2.1 <- feols(cowmidonset ~ regcha_uni + 
                ongoingrivalry + regcha_uni:ongoingrivalry +
                alliance +
                major + regcha_uni:major + 
                mindist + regcha_uni:mindist + 
                I(mindist^2) + regcha_uni:I(mindist^2) +
                trade_dyd + gdppc_dyd + nmc_dyd | 
                id + year, 
              cluster = c("year", "id"), data = dyadyrs)
m2.2 <- feols(cowmidonset ~ regcha_uni + 
                ongoingrivalry + regcha_uni:ongoingrivalry +
                alliance +
                major + regcha_uni:major + 
                mindist + regcha_uni:mindist + 
                I(mindist^2) + regcha_uni:I(mindist^2) +
                trade_dyd + gdppc_dyd + nmc_dyd | 
                ccode1 + ccode2 + year, 
              cluster = c("year", "ccode1", "ccode2"), data = dyadyrs)
etable(m2.1,m2.2, file = here::here("tables/2.tex"), view = TRUE)

# Key Explanatory Variable 2 Without Covariates
m3.1 <- feols(cowmidonset ~ regcha_uni + 
                ongoingrivalry + regcha_uni:ongoingrivalry | 
                id + year, 
              data = dyadyrs)
m3.2 <- feols(cowmidonset ~ regcha_uni + 
                ongoingrivalry + regcha_uni:ongoingrivalry | 
                id + year, 
              cluster = c("year", "id"), data = dyadyrs)
m3.3 <- feols(cowmidonset ~ regcha_uni + 
                ongoingrivalry + regcha_uni:ongoingrivalry | 
                ccode1 + ccode2 + year, 
              data = dyadyrs)
m3.4 <- feols(cowmidonset ~ regcha_uni  + 
                ongoingrivalry + regcha_uni:ongoingrivalry | 
                ccode1 + ccode2 + year, 
              cluster = c("year", "ccode1", "ccode2"), data = dyadyrs)
etable(m3.1, m3.2, m3.3, m3.4, file = here::here("tables/etr.tex"), view = TRUE)

# TWFE With Two Key Explanatory Variables With Covariates
m4 <- feols(cowmidonset ~ regcha_uni + 
              kappava + regcha_uni:kappava + 
              I(kappava^2) + regcha_uni:I(kappava^2) + 
              ongoingrivalry + regcha_uni:ongoingrivalry +
              alliance +
              major + regcha_uni:major + 
              mindist + regcha_uni:mindist + 
              I(mindist^2) + regcha_uni:I(mindist^2) +
              trade_dyd + gdppc_dyd + nmc_dyd | 
              ccode1 + ccode2 + year, 
            cluster = c("year", "ccode1", "ccode2"), data = dyadyrs)
etable(m4, view = TRUE)
```

## Event Study

```{r Event Study}
# tau
es <- dyadyrs %>%
  mutate(
    tau = year - treatyr_sing,
  )

es_reg <- feols(cowmidonset ~ factor(tau) + factor(tau):kappava | ccode1 + ccode2 + year, 
                cluster = c("year", "ccode1", "ccode2"), 
                data = filter(es, tau >= -9 & tau <= 8))

etable(es_reg, file = here::here("tables/esreg.tex"), view = TRUE)

es_regdat <- as_tibble(es_reg$coeftable)
es_regdat <- es_regdat[18:35,]
es_regdat$tau = -9:8
es_regdat$Est = es_regdat$Estimate-es_regdat$Estimate[es_regdat$tau==0]

ggplot(data = es_regdat, aes(x = tau, y = Est)) + 
  theme_minimal(base_size = 10) + 
  theme(text = element_text(family = "Crimson Text"))+
  xlab("Years Pre/Post Entry") + 
  ylab("Militarized Interstate Dispute") +
  labs(
    caption = "Correlates of War (CoW) Militarized Interstate Dispute (MID) project. (V5.0)"
  ) +
     geom_point() + 
  geom_errorbar(aes(ymax = Est+1.96*`Std. Error`, 
                    ymin = Est-1.96*`Std. Error`)) +
  geom_vline(xintercept = 0, 
             col = "darkred", lty = "dashed") + 
  geom_hline(yintercept = 0, 
             col = "darkgrey") +
  geom_smooth(data = subset(es_regdat, tau <= 0), se = TRUE) + 
  geom_smooth(data = subset(es_regdat, tau >= 0), se = TRUE)
ggsave(filename = here::here("plots/leadslags.png"), device = "png", limitsize = FALSE, dpi = 300)


dyadyrs$id <- as.numeric(dyadyrs$id)
dyadyrs$ccode1 <- as.numeric(dyadyrs$ccode1)
dyadyrs$ccode2 <- as.numeric(dyadyrs$ccode2)

#dyadyrs %>%
#  drop_na(regcha_uni, ongoingrivalry, alliance, major,
#          mindist, trade_dyd, gdppc_dyd, nmc_dyd)

example_attgt <- att_gt(yname = "cowmidonset",
                        tname = "year",
                        idname = "id",
                        gname = "treatyr_sing",
                        xformla = ~kappava,
                        data = dyadyrs,
                        base_period = "universal"
                        )
example_attgt.dyn <- aggte(example_attgt, type = "dynamic", na.rm = TRUE, 
                           min_e = -10, max_e = 10)
# summarize the results
print(summary(example_attgt.dyn))
ggdid(example_attgt.dyn) + theme(text = element_text(family = "Crimson Text", size = 11))





sensitivity_results <-
  honest_did(example_attgt.dyn,
             e=0,
             type="relative_magnitude",
             Mbarvec=seq(from = 0.5, to = 2, by = 0.5))

HonestDiD::createSensitivityPlot_relativeMagnitudes(sensitivity_results$robust_ci,
                                                    sensitivity_results$orig_ci)


betahat <- summary(es_regdat)$coefficients #save the coefficients
sigma <- summary(es_regdat)$cov.scaled #save the covariance matrix

delta_rm_results <- 
HonestDiD::createSensitivityResults_relativeMagnitudes(
                                    betahat = betahat, #coefficients
                                    sigma = sigma, #covariance matrix
                                    numPrePeriods = 9, #num. of pre-treatment coefs
                                    numPostPeriods = 9, #num. of post-treatment coefs
                                    Mbarvec = seq(0.5,2,by=0.5) #values of Mbar
                                    )

delta_rm_results
originalResults <- HonestDiD::constructOriginalCS(betahat = betahat,
                                                  sigma = sigma,
                                                  numPrePeriods = 5,
                                                  numPostPeriods = 2)

HonestDiD::createSensitivityPlot_relativeMagnitudes(delta_rm_results, originalResults)
```


```{r Mediation Analysis}
covariates <- c("alliance", 
                "major", "ongoingrivalry", 
                "mindist",
                "gdppc_dyd", "trade_dyd", "nmc_dyd")

media_test <- feols(c(alliance, 
                      major, ongoingrivalry, 
                      mindist, I(mindist^2),
                      gdppc_dyd, trade_dyd, nmc_dyd) ~ regcha_uni | 
                      year + ccode1 + ccode2, data = dyadyrs)
etable(media_test)
# stevemisc::show_ranef(media_test)
```
