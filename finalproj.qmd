---
title: "Final Project"
author: "Edison Hu"
format: pdf
editor: visual
date: (\today)
execute: 
  warning: false
  message: false
---

```{r, echo=FALSE}
library(fixest)
library(peacesciencer)
library(ggplot2)
library(tidyverse)
library(did)
library(MatchIt)
```

##Data Wrangling

```{r Data Wrangling}
ids <- c("ccode1", "ccode2", "country1", "country2", "year")

# Outcome Variable
## MID onsets
dyadyrs <- create_dyadyears(directed = FALSE, subset_years = c(1945:2010)) %>%
  add_cow_mids() %>%
  mutate(
    country1 = countrycode::countrycode(ccode1, 
                                        origin = "cown", destination = "iso3c"),
    country2 = countrycode::countrycode(ccode2, 
                                        origin = "cown", destination = "iso3c")  
    ) %>%
  select(all_of(ids), cowmidonset)

# Explanatory Variable
## regime change
polityIV <- readxl::read_xls(here::here("raw data/p4v2018.xls"))
polityIV <- polityIV %>%
  select(ccode, year, durable) %>%
  mutate(ccode2 = ccode) %>%
  rename(ccode1 = ccode)

dyadyrs <- left_join(dyadyrs, polityIV, by = c("ccode1", "year"))
dyadyrs <- dyadyrs %>%
  select(-ccode2.y) %>%
  rename(durable1 = durable,
         ccode2 = ccode2.x)
dyadyrs <- left_join(dyadyrs, polityIV, by = c("ccode2", "year"))
dyadyrs <- dyadyrs %>%
  select(-ccode1.y) %>%
  rename(durable2 = durable,
         ccode1 = ccode1.x)

dyadyrs <- dyadyrs %>%
  mutate(
    regcha1 = ifelse(durable1 == 0, 1, 0),
    regcha2 = ifelse(durable2 == 0, 1, 0),
    regcha_uni = ifelse(regcha1 == 1 | regcha2 == 1, 1, 0)
    #regcha_bi = ifelse(regcha1 == 1 & regcha2 == 1, 1, 0)
    ) %>%
  select(all_of(ids), cowmidonset, regcha_uni)

## foreign policy similarity
dyadyrs <- dyadyrs %>%
  add_fpsim() %>%
  select(all_of(ids), cowmidonset, regcha_uni, piva, kappava)

# Covariates
## alliance
dyadyrs <- dyadyrs %>%
  add_cow_alliance() %>%
  mutate(
    alliance = ifelse(cow_defense == 1 | cow_neutral== 1 | cow_nonagg == 1 | cow_entente == 1, 1, 0)
  ) %>%
  select(-c(cow_defense, cow_neutral, cow_nonagg, cow_entente))

## major power
dyadyrs <- dyadyrs %>%
  add_cow_majors() %>%
  mutate(major = ifelse(cowmaj1 == 1 | cowmaj2 == 1, 1, 0)) %>%
  select(-c(cowmaj1, cowmaj2))

## strategic rivalry
v_ids <- names(dyadyrs)
dyadyrs <- dyadyrs %>%
  add_strategic_rivalries() %>%
  select(all_of(v_ids), ongoingrivalry)

## distance
dyadyrs <- dyadyrs %>%
  add_minimum_distance()

## GDP per capita & Trade
v_ids <- names(dyadyrs)
dyadyrs <- dyadyrs %>%
  add_sdp_gdp() %>%
  add_cow_trade() %>%
  mutate(
    gdppc = wbgdppc2011est1 + wbgdppc2011est2,
    trade = flow1 + flow2
  ) %>%
  group_by(year) %>%
  mutate(
    gdppc_dyd = (gdppc - mean(gdppc, na.rm = TRUE)) / sd(gdppc, na.rm = TRUE),
    trade_dyd = (trade - mean(trade, na.rm = TRUE)) / sd(trade, na.rm = TRUE)
  ) %>%
  ungroup() 
dyadyrs <- dyadyrs %>%
  select(all_of(v_ids), gdppc, gdppc_dyd, trade, trade_dyd)
  
## Capability ratio
v_ids <- names(dyadyrs)
nmc_sy <- cow_nmc %>%
  rename(ccode1 = ccode,
         nc1 = cinc) %>%
  select(ccode1, year, nc1)
dyadyrs <- left_join(dyadyrs, nmc_sy, by = c("ccode1", "year"))

nmc_sy <- nmc_sy %>%
  rename(ccode2 = ccode1,
         nc2 = nc1)
dyadyrs <- left_join(dyadyrs, nmc_sy, by = c("ccode2", "year"))
dyadyrs <- dyadyrs %>%
  mutate(
    nc = abs(nc1 - nc2)
    ) %>%
  group_by(year) %>%
  mutate(
    nmc_dyd = (nc - mean(nc, na.rm = TRUE)) / sd(nc, na.rm = TRUE)
    ) %>%
  ungroup() %>%
  select(all_of(v_ids), nc, nmc_dyd)

## create unique id
dyadyrs <- dyadyrs %>%
  mutate(
    id = paste(ccode1, ccode2, sep = "0")
  )
```

# Treatment Year

```{r Treatment Year}
## treated year with single and multi-entry year
dyadyrs <- dyadyrs %>%
  group_by(id) %>%
  mutate(
    regchayr = ifelse(regcha_uni == 1, year, NA),
    treatyr_sing = min(regchayr, na.rm = TRUE)
    ) %>%
  ungroup() %>%
  select(-regchayr)
dyadyrs$treatyr_sing[dyadyrs$treatyr_sing == Inf] <- NA
#dyadyrs <- dyadyrs %>%
#  group_by(id) %>%
#  mutate(
#    regchayr = ifelse(regcha_uni == 1, year, NA),
#    treatyr_sing = min(regchayr, na.rm = TRUE),
#    treatyr_multi = regchayr
#  ) %>%
#  fill(treatyr_multi, .direction = "down") %>%
#  ungroup() %>%
#  select(-regchayr)

## unique cases id for multi-entry year dyads
#dyadyrs <- dyadyrs %>%
#  mutate(
#    case_id = row_number()
#  ) %>%
#  group_by(id, treatyr_multi) %>%
#  mutate(
#    case_id = min(case_id, na.rm = TRUE)
#  ) %>%
#  ungroup()
```

## Descriptive Analysis

```{r}
da <- dyadyrs %>%
  group_by(year) %>%
  summarise(
    onset = sum(cowmidonset, na.rm = TRUE),
    regime = sum(regcha_uni, na.rm = TRUE),
    avg_kappava = mean(kappava, na.rm = TRUE),
    sd_kappava = sd(kappava, na.rm = TRUE),
    alliance = sum(alliance, na.rm = TRUE),
    major = sum(major, na.rm = TRUE),
    rivalry = sum(ongoingrivalry, na.rm = TRUE),
    avg_gdppc = mean(gdppc, na.rm = TRUE),
    sd_gdppc = sd(gdppc, na.rm = TRUE),
    avg_trade = mean(trade, na.rm = TRUE),
    sd_trade = sd(trade, na.rm = TRUE),
    avg_nmc = mean(nc, na.rm = TRUE),
    sd_nmc = sd(nc, na.rm = TRUE)
  )

ggplot(data = da) +
  geom_line(aes(x = year, y = onset), color = "darkred", linewidth = 0.7) + 
  labs(
    x = "Year",
    y = "Numbers of Onsets",
    caption = "Source: Correlates of War (CoW) Militarized Interstate Dispute (MID) project. (V5.0)"
  ) + 
  ggthemes::theme_clean(base_size = 11) + 
  theme(text = element_text(family = "Crimson Text"))
ggsave(filename = here::here("plots/onset.png"), device = "png", 
        width = 5, height = 3, units = "in", dpi = 300, limitsize = FALSE)

ggplot(data = da) +
  geom_line(aes(x = year, y = regime), color = "darkgoldenrod1", linewidth = 0.7) + 
  labs(
    x = "Year",
    y = "Numbers of Dyads with Regime Change",
    caption = "Source: Polity IV Project (2018)"
  ) + ggthemes::theme_clean(base_size = 11) + 
  theme(text = element_text(family = "Crimson Text"))
ggsave(filename = here::here("plots/regime1945.png"), device = "png", 
        width = 5, height = 3, units = "in", dpi = 300, limitsize = FALSE)

#ggplot(data = da) +
#  geom_line(aes(x = year, y = regime), color = "darkgoldenrod1", linewidth = 0.7) + 
#  labs(
#    x = "Year",
#    y = "Numbers of Dyads with Regime Change",
#   caption = "Source: Polity IV Project (2018)"
#  ) + ggthemes::theme_clean(base_size = 11) + 
#  geom_vline(xintercept = 1945, color = "black") +
#  theme(text = element_text(family = "Crimson Text"))
#ggsave(filename = here::here("plots/regime1816.png"), device = "png", 
#       width = 5, height = 3, units = "in", dpi = 300, limitsize = FALSE)
```

## Effect Size

```{r Effect Size}
ees <- feols(cowmidonset ~ regcha_uni | year + ccode1 + ccode2, data = dyadyrs)
etable(ees, file = here::here("tables/ees.tex"), view = TRUE)

mde <- pwr::pwr.t.test(n = n_distinct(dyadyrs)/2, d = NULL, 
                       sig.level = 0.05, power = 0.8, 
                       type="two.sample", alternative="two.sided")
plot(mde)
```

## Parallel Trend Analysis

```{r Parallel Trend Analysis}
# single entry
pta <- dyadyrs %>%
  group_by(id) %>%
  mutate(
    mid = cowmidonset - lag(cowmidonset)
  ) %>%
  summarise(
    avg_mid = mean(mid, na.rm = TRUE),
    treatyr = unique(treatyr_sing)
  )

pta_model <- feols(treatyr ~ avg_mid, data = pta)
etable(pta_model, file = here::here("tables/pta.tex"), view = TRUE)

ggplot(pta, aes(x = treatyr, y = avg_mid)) +
  geom_smooth(method = "lm", se = TRUE) + 
  ggthemes::theme_clean(base_size = 11) +
  theme(text = element_text(family = "Crimson Text")) + 
  labs(
    x = "Year of Regime Change",
    y = "Mean Change of Militarized Interstate Dispute's Possibility",
    caption = "Source: COW MIDs Dataset"
  )
ggsave(filename = here::here("plots/paratrend.png"), device = "png", limitsize = FALSE, dpi = 300)


fractions = dyadyrs %>% 
  group_by(year) %>% 
  summarize(
    dyads = n_distinct(id),
    indyads = sum(regcha_uni, na.rm=TRUE),
    fracmid = mean(cowmidonset, na.rm=TRUE))

ggplot(data=fractions,aes(x=year)) + 
  ggthemes::theme_clean(base_size=11) + 
  xlab("Year") +
  geom_line(aes(y=fracmid), col="darkred") +
  #geom_line(aes(y=indyads*0.01), col="blue") +
  scale_y_continuous(
    name="Fraction Default")
    #sec.axis = sec_axis(~./0.01,name="Number in Bureau"))

# multi-entry 
#demo <- dyadyrs %>%
#  group_by(case_id) %>%
#  mutate(
#    mid = cowmidonset - lag(cowmidonset) # try n = 5
#  ) %>%
#  summarise(
#    avg_mid = mean(mid, na.rm = TRUE),
#    treatyr_multi = unique(treatyr_multi)
#  )

#idk <- feols(treatyr_multi ~ avg_mid, data = demo)
#etable(idk)

#ggplot(demo, aes(x = treatyr_multi)) +
#  geom_smooth(aes(y = avg_mid), se = TRUE)

```

## TWFE

```{r TWFE}
mdyadyrs <- dyadyrs %>%
  drop_na(regcha_uni, ongoingrivalry, alliance, major,
          mindist, trade_dyd, gdppc_dyd, nmc_dyd)
m.out <- matchit(regcha_uni ~ ongoingrivalry +
             alliance +
             major +
             mindist + I(mindist^2) +
             trade_dyd + gdppc_dyd + nmc_dyd,
             distance = "mahalanobis", data = mdyadyrs)

# Checking balance prior to matching
summary(m.out, un = FALSE)




# OLS
m <- feols(cowmidonset ~ regcha_uni + 
             kappava + regcha_uni:kappava + 
             ongoingrivalry + regcha_uni:ongoingrivalry +
             alliance +
             major + regcha_uni:major + 
             mindist + regcha_uni:mindist + 
             I(mindist^2) + regcha_uni:I(mindist^2) +
             trade_dyd + gdppc_dyd + nmc_dyd, 
           data = dyadyrs)
etable(m)

# Key Explanatory Variable 1 Without Covariates
m1.1 <- feols(cowmidonset ~ regcha_uni + 
                kappava + regcha_uni:kappava | 
                id + year, 
              data = dyadyrs)
m1.2 <- feols(cowmidonset ~ regcha_uni + 
                kappava + regcha_uni:kappava | 
                id + year, 
              cluster = c("year", "id"), data = dyadyrs)
m1.3 <- feols(cowmidonset ~ regcha_uni + 
                kappava + regcha_uni:kappava | 
              ccode1 + ccode2 + year, data = dyadyrs)
m1.4 <- feols(cowmidonset ~ regcha_uni  + 
                kappava + regcha_uni:kappava | 
              ccode1 + ccode2 + year, 
              cluster = c("year", "ccode1", "ccode2"), data = dyadyrs)
etable(m1.1, m1.2, m1.3, m1.4)

# TWFE with Key Explanatory Variables With Covariates
m2.1 <- feols(cowmidonset ~ regcha_uni + 
                ongoingrivalry + regcha_uni:ongoingrivalry +
                alliance +
                major + regcha_uni:major + 
                mindist + regcha_uni:mindist + 
                I(mindist^2) + regcha_uni:I(mindist^2) +
                trade_dyd + gdppc_dyd + nmc_dyd | 
                id + year, 
              cluster = c("year", "id"), data = dyadyrs)
m2.2 <- feols(cowmidonset ~ regcha_uni + 
                ongoingrivalry + regcha_uni:ongoingrivalry +
                alliance +
                major + regcha_uni:major + 
                mindist + regcha_uni:mindist + 
                I(mindist^2) + regcha_uni:I(mindist^2) +
                trade_dyd + gdppc_dyd + nmc_dyd | 
                ccode1 + ccode2 + year, 
              cluster = c("year", "ccode1", "ccode2"), data = dyadyrs)
etable(m2.1,m2.2, file = here::here("tables/2.tex"), view = TRUE)

# Key Explanatory Variable 2 Without Covariates
m3.1 <- feols(cowmidonset ~ regcha_uni + 
                ongoingrivalry + regcha_uni:ongoingrivalry | 
                id + year, 
              data = dyadyrs)
m3.2 <- feols(cowmidonset ~ regcha_uni + 
                ongoingrivalry + regcha_uni:ongoingrivalry | 
                id + year, 
              cluster = c("year", "id"), data = dyadyrs)
m3.3 <- feols(cowmidonset ~ regcha_uni + 
                ongoingrivalry + regcha_uni:ongoingrivalry | 
                ccode1 + ccode2 + year, 
              data = dyadyrs)
m3.4 <- feols(cowmidonset ~ regcha_uni  + 
                ongoingrivalry + regcha_uni:ongoingrivalry | 
                ccode1 + ccode2 + year, 
              cluster = c("year", "ccode1", "ccode2"), data = dyadyrs)
etable(m3.1, m3.2, m3.3, m3.4, file = here::here("tables/etr.tex"), view = TRUE)

# TWFE With Two Key Explanatory Variables With Covariates
m4 <- feols(cowmidonset ~ regcha_uni + 
              kappava + regcha_uni:kappava + 
              I(kappava^2) + regcha_uni:I(kappava^2) + 
              ongoingrivalry + regcha_uni:ongoingrivalry +
              alliance +
              major + regcha_uni:major + 
              mindist + regcha_uni:mindist + 
              I(mindist^2) + regcha_uni:I(mindist^2) +
              trade_dyd + gdppc_dyd + nmc_dyd | 
              ccode1 + ccode2 + year, 
            cluster = c("year", "ccode1", "ccode2"), data = dyadyrs)
etable(m4)
```

## Event Study

```{r Event Study}
# tau
es <- dyadyrs %>%
  mutate(
    tau = year - treatyr_sing,
  )

es_reg <- feols(cowmidonset ~ factor(tau) + factor(tau):kappava | ccode1 + ccode2 + year, 
                cluster = c("year", "ccode1", "ccode2"), 
                data = filter(es, tau >= -9 & tau <= 8))

etable(es_reg, file = here::here("tables/esreg.tex"), view = TRUE)

es_regdat <- as_tibble(es_reg$coeftable)
es_regdat <- es_regdat[18:35,]
es_regdat$tau = -9:8
es_regdat$Est = es_regdat$Estimate-es_regdat$Estimate[es_regdat$tau==0]

ggplot(data = es_regdat, aes(x = tau, y = Est)) + 
  theme_minimal(base_size = 10) + 
  theme(text = element_text(family = "Crimson Text"))+
  xlab("Years Pre/Post Entry") + 
  ylab("Militarized Interstate Dispute") +
  labs(
    caption = "Correlates of War (CoW) Militarized Interstate Dispute (MID) project. (V5.0)"
  ) +
     geom_point() + 
  geom_errorbar(aes(ymax = Est+1.96*`Std. Error`, 
                    ymin = Est-1.96*`Std. Error`)) +
  geom_vline(xintercept = 0, 
             col = "darkred", lty = "dashed") + 
  geom_hline(yintercept = 0, 
             col = "darkgrey") +
  geom_smooth(data = subset(es_regdat, tau <= 0), se = TRUE) + 
  geom_smooth(data = subset(es_regdat, tau >= 0), se = TRUE)
ggsave(filename = here::here("plots/leadslags.png"), device = "png", limitsize = FALSE, dpi = 300)

dyadyrs$id <- as.numeric(dyadyrs$id)

example_attgt <- att_gt(yname = "cowmidonset",
                        tname = "year",
                        idname = "id",
                        gname = "treatyr_sing",
                        #xformla = ~1,
                        control_group = "notyettreated",
                        data = dyadyrs
                        )
example_attgt.dyn <- aggte(example_attgt, type = "dynamic", na.rm = TRUE, 
                           min_e = -10, max_e = 10)
# summarize the results
print(summary(example_attgt.dyn))
ggdid(example_attgt.dyn) + theme(text = element_text(family = "Crimson Text", size = 11))
```

## Cross-sectional Endogeneity Test

```{r}

```

```{r Mediation Analysis}
covariates <- c("alliance", 
                "major", "ongoingrivalry", 
                "mindist",
                "gdppc_dyd", "trade_dyd", "nmc_dyd")

media_test <- feols(c(alliance, 
                      major, ongoingrivalry, 
                      mindist, I(mindist^2),
                      gdppc_dyd, trade_dyd, nmc_dyd) ~ regcha_uni | 
                      year + ccode1 + ccode2, data = dyadyrs)
etable(media_test)
# stevemisc::show_ranef(media_test)
```
